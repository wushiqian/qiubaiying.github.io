---
layout:     post
title:      事件总线与EventBus
subtitle:   Android
date:       2019-07-18
author:     wushiqian
header-img: img/post-bg-temple.jpg
catalog: true
tags:
    - Android
    - EventBus
---

# EvenBus

## 使用

### 三要素和四种ThreadMode

三要素

* Event：事件，可以是任意类型的对象。
* Subscriber：事件订阅者，在EventBus3.0之前消息处理的方法只能限定于onEvent、onEventMainThread、onEventBackgroundThread和onEventAsync，他们分别代表四种线程模型。而在EventBus3.0之后，事件处理的方法可以随便取名，但是需要添加一个注解@Subscribe，并且要指定线程模型（默认为POSTING）。
* Publisher：事件发布者，可以在任意线程任意位置发送事件，直接调用EventBus的post(Object)方法。可以自己实例化EventBus对象，但一般使用EventBus.getDefault()就好了，根据post函数参数的类型，会自动调用订阅相应类型事件的函数。

四种ThreadMode

* POSTING（默认）：如果使用事件处理函数指定了线程模型为POSTING，那么该事件在哪个线程发布出来的，事件处理函数就会在这个线程中运行，也就是说发布事件和接收事件在同一个线程。在线程模型为POSTING的事件处理函数中尽量避免执行耗时操作，因为它会阻塞事件的传递，甚至有可能会引起ANR。
* MAIN：事件的处理会在UI线程中执行。事件处理时间不能太长，长了会ANR的。
* BACKGROUND：如果事件是在UI线程中发布出来的，那么该事件处理函数就会在新的线程中运行，如果事件本来就是子线程中发布出来的，那么该事件处理函数直接在发布事件的线程中执行。在此事件处理函数中禁止进行UI更新操作。
* ASYNC：无论事件在哪个线程发布，该事件处理函数都会在新建的子线程中执行，同样，此事件处理函数中禁止进行UI更新操作。

EventBus使用起来很简单，分为五个步骤：

1.自定义一个事件类

```
public class MessageEvent {
    ...
}
```
2.在需要订阅事件的地方注册事件

```
EventBus.getDefault().register(this);
```
3.发送事件

```
EventBus.getDefault().post(messageEvent);
```
4.处理事件

```
@Subscribe(threadMode = ThreadMode.MAIN)
public void XXX(MessageEvent messageEvent) {
    ...
}
```
前面我们说过，消息处理的方法可以随便取名，但是需要添加一个注解@Subscribe，并且要指定线程模型（默认为POSTING）。

5.取消事件订阅

```
EventBus.getDefault().unregister(this);
```

### 粘性事件

订阅者处理粘性事件
在MainActivity中新写一个方法用来处理粘性事件：

```
@Subscribe(threadMode = ThreadMode.POSTING，sticky = true)
 public void ononMoonStickyEvent(MessageEvent messageEvent){
     tv_message.setText(messageEvent.getMessage());
 }
```
发送黏性事件
在SecondActivity中我们定义一个Button来发送粘性事件：

```
bt_subscription.setOnClickListener(new View.OnClickListener() {
         @Override
         public void onClick(View v) {
             EventBus.getDefault().postSticky(new MessageEvent("粘性事件"));
             finish();
         }
     });
```

## EventBus3.0源码解析

### EventBus构造方法

### 订阅者注册

### 事件的发送

### 订阅者取消注册

[源码解析](http://liuwangshu.cn/application/eventbus/2-eventbus-sourcecode.html)